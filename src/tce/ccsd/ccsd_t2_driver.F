      SUBROUTINE ccsd_t2(d_f1,d_i0,d_t1,d_t2,d_v2,k_f1_offset,k_i0_offse
     &t,k_t1_offset,k_t2_offset,k_v2_offset)
C     $Id: ccsd_t2.F 19699 2010-10-29 17:07:13Z d3y133 $
C     This is a Fortran77 program generated by Tensor Contraction Engine v.1.0
C     Copyright (c) Battelle & Pacific Northwest National Laboratory (2002)
C     i0 ( p3 p4 h1 h2 )_v+= 1*v ( p3 p4 h1 h2 )_v                                                         DONE
C     i0 ( p3 p4 h1 h2 )_vt+= -1*P( 2 )*Sum ( h10 )*t ( p3 h10 )_t*i1 ( h10 p4 h1 h2 )_v             DONE
C         i1 ( h10 p3 h1 h2 )_v+= 1*v ( h10 p3 h1 h2 )_v                                                   DONE
C         i1 ( h10 p3 h1 h2 )_vt+= 1/2*Sum ( h11 )*t ( p3 h11 )_t*i2 ( h10 h11 h1 h2 )_v               DONE
C             i2 ( h10 h11 h1 h2 )_v+= -1*v ( h10 h11 h1 h2 )_v                                            DONE
C             i2 ( h10 h11 h1 h2 )_vt+= 1*P( 2 )*Sum ( p5 )*t ( p5 h1 )_t*i3 ( h10 h11 h2 p5 )_v
C                 i3 ( h10 h11 h1 p5 )_v+= 1*v ( h10 h11 h1 p5 )_v                                         DONE
C                 i3 ( h10 h11 h1 p5 )_vt+= -1/2*Sum ( p6 )*t ( p6 h1 )_t*v ( h10 h11 p5 p6 )_v
C             i2 ( h10 h11 h1 h2 )_vt+= -1/2*Sum ( p7 p8 )*t ( p7 p8 h1 h2 )_t*v ( h10 h11 p7 p8 )_v
C         i1 ( h10 p3 h1 h2 )_vt+= -1*P( 2 )*Sum ( p5 )*t ( p5 h1 )_t*i2 ( h10 p3 h2 p5 )_v
C             i2 ( h10 p3 h1 p5 )_v+= 1*v ( h10 p3 h1 p5 )_v                                               DONE
C             i2 ( h10 p3 h1 p5 )_vt+= -1/2*Sum ( p6 )*t ( p6 h1 )_t*v ( h10 p3 p5 p6 )_v
C         i1 ( h10 p3 h1 h2 )_ft+= -1*Sum ( p5 )*t ( p3 p5 h1 h2 )_t*i2 ( h10 p5 )_f
C             i2 ( h10 p5 )_f+= 1*f ( h10 p5 )_f                                                           DONE
C             i2 ( h10 p5 )_vt+= -1*Sum ( h7 p6 )*t ( p6 h7 )_t*v ( h7 h10 p5 p6 )_v
C         i1 ( h10 p3 h1 h2 )_vt+= 1*P( 2 )*Sum ( h7 p9 )*t ( p3 p9 h1 h7 )_t*i2 ( h7 h10 h2 p9 )_v
C             i2 ( h7 h10 h1 p9 )_v+= 1*v ( h7 h10 h1 p9 )_v                                               DONE
C             i2 ( h7 h10 h1 p9 )_vt+= 1*Sum ( p5 )*t ( p5 h1 )_t*v ( h7 h10 p5 p9 )_v
C         i1 ( h10 p3 h1 h2 )_vt+= 1/2*Sum ( p5 p6 )*t ( p5 p6 h1 h2 )_t*v ( h10 p3 p5 p6 )_v
C     i0 ( p3 p4 h1 h2 )_vt+= -1*P( 2 )*Sum ( p5 )*t ( p5 h1 )_t*i1 ( p3 p4 h2 p5 )_v               UNUSED (NOPE)
C         i1 ( p3 p4 h1 p5 )_v+= 1*v ( p3 p4 h1 p5 )_v                                                    UNUSED (NOPE)
C         i1 ( p3 p4 h1 p5 )_vt+= -1/2*Sum ( p6 )*t ( p6 h1 )_t*v ( p3 p4 p5 p6 )_v                   UNUSED (NOPE)
C     i0 ( p3 p4 h1 h2 )_tf+= -1*P( 2 )*Sum ( h9 )*t ( p3 p4 h1 h9 )_t*i1 ( h9 h2 )_f
C         i1 ( h9 h1 )_f+= 1*f ( h9 h1 )_f                                                                 DONE
C         i1 ( h9 h1 )_ft+= 1*Sum ( p8 )*t ( p8 h1 )_t*i2 ( h9 p8 )_f                                  DONE
C             i2 ( h9 p8 )_f+= 1*f ( h9 p8 )_f                                                             DONE
C             i2 ( h9 p8 )_vt+= 1*Sum ( h7 p6 )*t ( p6 h7 )_t*v ( h7 h9 p6 p8 )_v
C         i1 ( h9 h1 )_vt+= -1*Sum ( h7 p6 )*t ( p6 h7 )_t*v ( h7 h9 h1 p6 )_v
C         i1 ( h9 h1 )_vt+= -1/2*Sum ( h8 p6 p7 )*t ( p6 p7 h1 h8 )_t*v ( h8 h9 p6 p7 )_v
C     i0 ( p3 p4 h1 h2 )_tf+= 1*P( 2 )*Sum ( p5 )*t ( p3 p5 h1 h2 )_t*i1 ( p4 p5 )_f                 DONE
C         i1 ( p3 p5 )_f+= 1*f ( p3 p5 )_f                                                                 DONE
C         i1 ( p3 p5 )_vt+= -1*Sum ( h7 p6 )*t ( p6 h7 )_t*v ( h7 p3 p5 p6 )_v
C         i1 ( p3 p5 )_vt+= -1/2*Sum ( h7 h8 p6 )*t ( p3 p6 h7 h8 )_t*v ( h7 h8 p5 p6 )_v
C     i0 ( p3 p4 h1 h2 )_vt+= -1/2*Sum ( h11 h9 )*t ( p3 p4 h9 h11 )_t*i1 ( h9 h11 h1 h2 )_v
C         i1 ( h9 h11 h1 h2 )_v+= -1*v ( h9 h11 h1 h2 )_v                                                  DONE
C         i1 ( h9 h11 h1 h2 )_vt+= 1*P( 2 )*Sum ( p8 )*t ( p8 h1 )_t*i2 ( h9 h11 h2 p8 )_v
C             i2 ( h9 h11 h1 p8 )_v+= 1*v ( h9 h11 h1 p8 )_v                                               DONE
C             i2 ( h9 h11 h1 p8 )_vt+= 1/2*Sum ( p6 )*t ( p6 h1 )_t*v ( h9 h11 p6 p8 )_v
C         i1 ( h9 h11 h1 h2 )_vt+= -1/2*Sum ( p5 p6 )*t ( p5 p6 h1 h2 )_t*v ( h9 h11 p5 p6 )_v
C     i0 ( p3 p4 h1 h2 )_vt+= -1*P( 4 )*Sum ( h6 p5 )*t ( p3 p5 h1 h6 )_t*i1 ( h6 p4 h2 p5 )_v
C         i1 ( h6 p3 h1 p5 )_v+= 1*v ( h6 p3 h1 p5 )_v                                                     DONE
C         i1 ( h6 p3 h1 p5 )_vt+= -1*Sum ( p7 )*t ( p7 h1 )_t*v ( h6 p3 p5 p7 )_v
C         i1 ( h6 p3 h1 p5 )_vt+= -1/2*Sum ( h8 p7 )*t ( p3 p7 h1 h8 )_t*v ( h6 h8 p5 p7 )_v
C     i0 ( p3 p4 h1 h2 )_vt+= 1/2*Sum ( p5 p6 )*t ( p5 p6 h1 h2 )_t*v ( p3 p4 p5 p6 )_v
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "util.fh"
#include "errquit.fh"
#include "tce.fh"
#include "tce_main.fh"
c when local copies of  T1/X1 tensors are used,  d_t1 refers to k_t1_local (kk)
c local copies of the most important 2-dimensional intermediates
c ccsd_t2_4(...) and ccsd_t2_5(...) (kk)
      INTEGER d_i0
      INTEGER k_i0_offset
      INTEGER d_v2
      INTEGER k_v2_offset
      INTEGER d_t1
      INTEGER k_t1_offset
      INTEGER d_i1
      INTEGER k_i1_offset
      INTEGER d_t2
      INTEGER k_t2_offset
      INTEGER l_i1_offset
      INTEGER size_i1
      INTEGER d_i2
      INTEGER k_i2_offset
      INTEGER l_i2_offset
      INTEGER size_i2
c      INTEGER size_t2
      INTEGER d_i3
      INTEGER k_i3_offset
      INTEGER l_i3_offset
      INTEGER size_i3
      INTEGER d_f1
      INTEGER k_f1_offset
c-T1/X1 LOCALIZATION -------------------
      integer l_i1_local,k_i1_local
c ---------------------------------------
      CHARACTER*255 filename
      logical nodezero         ! True if node 0
      double precision cpu     ! CPU sec counter
      double precision wall    ! WALL sec counter
      nodezero=(ga_nodeid().eq.0)

c this is now in ccsd_t1...
c      call tpi_start(18)

      call tpi_push_name_level2("ccsd_t2_1")
      CALL ccsd_t2_1(d_v2,k_v2_offset,d_i0,k_i0_offset)
      call tpi_pop_name_level2("ccsd_t2_1")

      call tpi_push_name_level2("OFFSET_ccsd_t2_2_1")
      CALL OFFSET_ccsd_t2_2_1(l_i1_offset,k_i1_offset,size_i1)
      call tpi_pop_name_level2("OFFSET_ccsd_t2_2_1")

      call tpi_push_name_level2("CREATEFILE_ccsd_t2_2_1_i1")
      CALL TCE_FILENAME('ccsd_t2_2_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)
      call tpi_pop_name_level2("CREATEFILE_ccsd_t2_2_1_i1")

      call tpi_push_name_level2("ccsd_t2_2_1")
      CALL ccsd_t2_2_1(d_v2,k_v2_offset,d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_2_1")

      CALL OFFSET_ccsd_t2_2_2_1(l_i2_offset,k_i2_offset,size_i2)

      CALL TCE_FILENAME('ccsd_t2_2_2_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_2_2_1")
      CALL ccsd_t2_2_2_1(d_v2,k_v2_offset,d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_2_2_1")

      CALL OFFSET_ccsd_t2_2_2_2_1(l_i3_offset,k_i3_offset,size_i3)

      CALL TCE_FILENAME('ccsd_t2_2_2_2_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)

      call tpi_push_name_level2("ccsd_t2_2_2_2_1")
      CALL ccsd_t2_2_2_2_1(d_v2,k_v2_offset,d_i3,k_i3_offset)
      call tpi_pop_name_level2("ccsd_t2_2_2_2_1")

      call tpi_push_name_level2("ccsd_t2_2_2_2_2")
      CALL ccsd_t2_2_2_2_2(d_t1,k_t1_offset,d_v2,k_v2_offset,
     1                     d_i3,k_i3_offset)
      call tpi_pop_name_level2("ccsd_t2_2_2_2_2")

      CALL RECONCILEFILE(d_i3,size_i3)

      call tpi_push_name_level2("ccsd_t2_2_2_2")
      CALL ccsd_t2_2_2_2(d_t1,k_t1_offset,d_i3,k_i3_offset,
     1                   d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_2_2_2")

      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)

      call tpi_push_name_level2("ccsd_t2_2_2_3")
      CALL ccsd_t2_2_2_3(d_t2,k_t2_offset,d_v2,k_v2_offset,
     1                   d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_2_2_3")

      CALL RECONCILEFILE(d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_2_2")
      CALL ccsd_t2_2_2(d_t1,k_t1_offset,d_i2,k_i2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_2_2")

      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)
      CALL OFFSET_ccsd_t2_2_4_1(l_i2_offset,k_i2_offset,size_i2)
      CALL TCE_FILENAME('ccsd_t2_2_4_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_2_4_1")
      CALL ccsd_t2_2_4_1(d_f1,k_f1_offset,d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_2_4_1")

      call tpi_push_name_level2("ccsd_t2_2_4_2")
      CALL ccsd_t2_2_4_2(d_t1,k_t1_offset,d_v2,k_v2_offset,
     1                   d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_2_4_2")

      CALL RECONCILEFILE(d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_2_4")
      CALL ccsd_t2_2_4(d_t2,k_t2_offset,d_i2,k_i2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_2_4")

      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)
      CALL OFFSET_ccsd_t2_2_5_1(l_i2_offset,k_i2_offset,size_i2)
      CALL TCE_FILENAME('ccsd_t2_2_5_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_2_5_1")
      CALL ccsd_t2_2_5_1(d_v2,k_v2_offset,d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_2_5_1")

      call tpi_push_name_level2("ccsd_t2_2_5_2")
      CALL ccsd_t2_2_5_2(d_t1,k_t1_offset,d_v2,k_v2_offset,
     1                   d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_2_5_2")

      CALL RECONCILEFILE(d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_2_5")
      CALL ccsd_t2_2_5(d_t2,k_t2_offset,d_i2,k_i2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_2_5")

      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)

      call tpi_push_name_level2("c2f_t2_t12a")
      CALL c2f_t2_t12(d_t1,k_t1_offset,d_t2,k_t2_offset)
      call tpi_pop_name_level2("c2f_t2_t12a")

      call tpi_push_name_level2("ccsd_t2_2_6")
      CALL ccsd_t2_2_6(d_t2,k_t2_offset,d_v2,k_v2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_2_6")

      call tpi_push_name_level2("c2d_t2_t12a")
      CALL c2d_t2_t12(d_t1,k_t1_offset,d_t2,k_t2_offset) 
      call tpi_pop_name_level2("c2d_t2_t12a")

      CALL RECONCILEFILE(d_i1,size_i1)

      call tpi_push_name_level2("ccsd_t2_2")
      CALL ccsd_t2_2(d_t1,k_t1_offset,d_i1,k_i1_offset,d_i0,k_i0_offset)
      call tpi_pop_name_level2("ccsd_t2_2")

      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)

      call tpi_push_name_level2("lccsd_t2_3x")
      CALL lccsd_t2_3x(d_t1,k_t1_offset,d_v2,k_v2_offset,
     1                 d_i0,k_i0_offset)
      call tpi_pop_name_level2("lccsd_t2_3x")

      CALL OFFSET_ccsd_t2_4_1(l_i1_offset,k_i1_offset,size_i1)
      CALL TCE_FILENAME('ccsd_t2_4_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)

      call tpi_push_name_level2("ccsd_t2_4_1")
      CALL ccsd_t2_4_1(d_f1,k_f1_offset,d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_4_1")

      CALL OFFSET_ccsd_t2_4_2_1(l_i2_offset,k_i2_offset,size_i2)
      CALL TCE_FILENAME('ccsd_t2_4_2_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_4_2_1")
      CALL ccsd_t2_4_2_1(d_f1,k_f1_offset,d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_4_2_1")

      call tpi_push_name_level2("ccsd_t2_4_2_2")
      CALL ccsd_t2_4_2_2(d_t1,k_t1_offset,d_v2,k_v2_offset,
     1                   d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_4_2_2")

      CALL RECONCILEFILE(d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_4_2")
      CALL ccsd_t2_4_2(d_t1,k_t1_offset,d_i2,k_i2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_4_2")

      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)

      call tpi_push_name_level2("ccsd_t2_4_3")
      CALL ccsd_t2_4_3(d_t1,k_t1_offset,d_v2,k_v2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_4_3")

      call tpi_push_name_level2("ccsd_t2_4_4")
      CALL ccsd_t2_4_4(d_t2,k_t2_offset,d_v2,k_v2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_4_4")

      CALL RECONCILEFILE(d_i1,size_i1)
c-T1/X1 LOCALIZATION ----------
        if (.not.MA_PUSH_GET(mt_dbl,size_i1,'i1_local',
     1      l_i1_local,k_i1_local))
     1      call errquit('i1_local',1,MA_ERR)
        call ma_zero(dbl_mb(k_i1_local),size_i1)
c    copy d_t1 ==> l_t1_local
        call ga_get(d_i1,1,size_i1,1,1,dbl_mb(k_i1_local),1)
c -------------------------------
ccx      CALL ccsd_t2_4(d_t2,k_t2_offset,d_i1,k_i1_offset,d_i0,k_i0_offset)

      call tpi_push_name_level2("ccsd_t2_4")
      CALL ccsd_t2_4(d_t2,k_t2_offset,k_i1_local,k_i1_offset,
     &              d_i0,k_i0_offset)
      call tpi_pop_name_level2("ccsd_t2_4")

c-T1/X1 LOCALIZATION --
         if(.not.MA_POP_STACK(l_i1_local))
     &      call errquit('l_i1_local',2,MA_ERR)
c -----------------------
      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)
      CALL OFFSET_ccsd_t2_5_1(l_i1_offset,k_i1_offset,size_i1)
      CALL TCE_FILENAME('ccsd_t2_5_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)

      call tpi_push_name_level2("ccsd_t2_5_1")
      CALL ccsd_t2_5_1(d_f1,k_f1_offset,d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_5_1")

      call tpi_push_name_level2("ccsd_t2_5_2")
      CALL ccsd_t2_5_2(d_t1,k_t1_offset,d_v2,k_v2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_5_2")

      call tpi_push_name_level2("ccsd_t2_5_3")
      CALL ccsd_t2_5_3(d_t2,k_t2_offset,d_v2,k_v2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_5_3")

      CALL RECONCILEFILE(d_i1,size_i1)
c-T1/X1 LOCALIZATION ----------
        if (.not.MA_PUSH_GET(mt_dbl,size_i1,'i1_local',
     1      l_i1_local,k_i1_local))
     1      call errquit('i1_local',1,MA_ERR)
        call ma_zero(dbl_mb(k_i1_local),size_i1)
c    copy d_t1 ==> l_t1_local
        call ga_get(d_i1,1,size_i1,1,1,dbl_mb(k_i1_local),1)
c -------------------------------
ccx      CALL ccsd_t2_5(d_t2,k_t2_offset,d_i1,k_i1_offset,d_i0,k_i0_offset)

      call tpi_push_name_level2("ccsd_t2_5")
      CALL ccsd_t2_5(d_t2,k_t2_offset,k_i1_local,k_i1_offset,
     &               d_i0,k_i0_offset)
      call tpi_pop_name_level2("ccsd_t2_5")

c-T1/X1 LOCALIZATION --
         if(.not.MA_POP_STACK(l_i1_local))
     &      call errquit('l_i1_local',2,MA_ERR)
c -----------------------
      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)
      CALL OFFSET_ccsd_t2_6_1(l_i1_offset,k_i1_offset,size_i1)
      CALL TCE_FILENAME('ccsd_t2_6_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)

      call tpi_push_name_level2("ccsd_t2_6_1")
      CALL ccsd_t2_6_1(d_v2,k_v2_offset,d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_6_1")

      CALL OFFSET_ccsd_t2_6_2_1(l_i2_offset,k_i2_offset,size_i2)
      CALL TCE_FILENAME('ccsd_t2_6_2_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_6_2_1")
      CALL ccsd_t2_6_2_1(d_v2,k_v2_offset,d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_6_2_1")

      call tpi_push_name_level2("ccsd_t2_6_2_2")
      CALL ccsd_t2_6_2_2(d_t1,k_t1_offset,d_v2,k_v2_offset,
     1                   d_i2,k_i2_offset)
      call tpi_pop_name_level2("ccsd_t2_6_2_2")

      CALL RECONCILEFILE(d_i2,size_i2)

      call tpi_push_name_level2("ccsd_t2_6_2")
      CALL ccsd_t2_6_2(d_t1,k_t1_offset,d_i2,k_i2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_6_2")

      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)

      call tpi_push_name_level2("ccsd_t2_6_3")
      CALL ccsd_t2_6_3(d_t2,k_t2_offset,d_v2,k_v2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_6_3")

      CALL RECONCILEFILE(d_i1,size_i1)

      call tpi_push_name_level2("ccsd_t2_6")
      CALL ccsd_t2_6(d_t2,k_t2_offset,d_i1,k_i1_offset,d_i0,k_i0_offset)
      call tpi_pop_name_level2("ccsd_t2_6")

      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)
      CALL OFFSET_ccsd_t2_7_1(l_i1_offset,k_i1_offset,size_i1)
      CALL TCE_FILENAME('ccsd_t2_7_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)

      call tpi_push_name_level2("ccsd_t2_7_1")
      CALL ccsd_t2_7_1(d_v2,k_v2_offset,d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_7_1")

      call tpi_push_name_level2("ccsd_t2_7_2")
      CALL ccsd_t2_7_2(d_t1,k_t1_offset,d_v2,k_v2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_7_2")

      call tpi_push_name_level2("ccsd_t2_7_3")
      CALL ccsd_t2_7_3(d_t2,k_t2_offset,d_v2,k_v2_offset,
     1                 d_i1,k_i1_offset)
      call tpi_pop_name_level2("ccsd_t2_7_3")

      CALL RECONCILEFILE(d_i1,size_i1)

      call tpi_push_name_level2("ccsd_t2_7")
      CALL ccsd_t2_7(d_t2,k_t2_offset,d_i1,k_i1_offset,d_i0,k_i0_offset)
      call tpi_pop_name_level2("ccsd_t2_7")

      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) 
     1    CALL ERRQUIT('ccsd_t2',-1,MA_ERR)
      CALL OFFSET_vt1t1_1_1(l_i1_offset,k_i1_offset,size_i1)
      CALL TCE_FILENAME('vt1t1_1_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)

      call tpi_push_name_level2("vt1t1_1_2")
      CALL vt1t1_1_2(d_t1,k_t1_offset,d_v2,k_v2_offset,d_i1,k_i1_offset)
      call tpi_pop_name_level2("vt1t1_1_2")

      CALL RECONCILEFILE(d_i1,size_i1)

      call tpi_push_name_level2("vt1t1_1")
      CALL vt1t1_1(d_t1,k_t1_offset,d_i1,k_i1_offset,d_i0,k_i0_offset)
      call tpi_pop_name_level2("vt1t1_1")

      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) 
     1    CALL ERRQUIT('vt1t1',-1,MA_ERR)

      call tpi_push_name_level2("c2f_t2_t12b")
      CALL c2f_t2_t12(d_t1,k_t1_offset,d_t2,k_t2_offset)
      call tpi_pop_name_level2("c2f_t2_t12b")

#ifdef NEW_COMM_STRUCT
      call tpi_push_name_level2("ccsd_t2_8s")
      CALL ccsd_t2_8_spiral(d_t2,k_t2_offset,d_v2,k_v2_offset,
     1                      d_i0,k_i0_offset)
      call tpi_pop_name_level2("ccsd_t2_8s")
#else
      call tpi_push_name_level2("ccsd_t2_8")
      CALL ccsd_t2_8(d_t2,k_t2_offset,d_v2,k_v2_offset,
     1               d_i0,k_i0_offset)
      call tpi_pop_name_level2("ccsd_t2_8")
#endif

      call tpi_push_name_level2("c2d_t2_t12b")
      CALL c2d_t2_t12(d_t1,k_t1_offset,d_t2,k_t2_offset)
      call tpi_pop_name_level2("c2d_t2_t12b")

      RETURN
      END
